<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="./css/newDash.css">
    <link rel="shortcut icon" type="imagex/png" href="./imgs/logoSemEscrita_techbins-removebg-preview.ico">
</head>

<body onload="addRep()" >
    <div class="div_nav">
        <div class="links_dash">
            <div class="perfil">
                <img src="./imgs/userimg.png" alt="foto_perfil" style="border-radius: 30px;" width="50px">
                <div class="hello">
                    <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
                </div>
            </div>
            <ul class="links">
                <li>
                    <a href="index.html" class="link_nav">Home</a>
                </li>
                <li>
                    <a href="newDashboard.html" class="link_nav">Dashboards</a>
                </li>
                <li>
                    <a href="graficos.html" class="link_nav">Gráficos gerais</a>
                </li>

                <li>
                    <a href="rotas.html" class="link_nav">Rotas</a>
                </li>
                <li>
                    <a href="cadastro.html" class="link_nav" id="cadastro">Adicionar representante</a>
                </li>
                <li>
                    <a href="https://sptech-team-vbjwf7te.atlassian.net/servicedesk/customer/portal/1" target="_blank"
                        class="link_nav">Algum problema? <br> Contate-nos</a>
                </li>
            </ul>


        </div>

        <div onclick="sair()">
            <h1>Sair ></h1>
        </div>
        <a href="index.html"><img src="imgs/logo_techbins.png" alt="Logo da TechBins" id="img_logo_nav"></a>

    </div>

<div class="containerDashboard">
    <div id="rotas" class="rotas">   
    </div>
        <div id="div_alerta">
    </div>
</div>


</body>
<script>
    buscarDadosRotas();

    
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    function sair() {
        sessionStorage.clear();
        window.location = "../index.html";
    }

    function addRep() {
        if (sessionStorage.PODE_ADICIONAR == 'N') {
            cadastro.style.display = "none";
        }
    }

     var rotasList = [];
    function buscarDadosRotas() {
        rotas.innerHTML = "";
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch("/dashboard/mediaRota", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idUsuarioServer: idUsuario
            }),
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    for (var i = 0; i < resposta.length; i++) {
                        var mediaGeralNivel = 0;
                        var cor = null;
                        if (resposta[i].media_geral_rota <= 18) {
                            cor = "red";
                            mediaGeralNivel = 5;
                        } else if (resposta[i].media_geral_rota <= 36) {
                            mediaGeralNivel = 4;
                            cor = "yellow";
                        } else if (resposta[i].media_geral_rota <= 54) {
                            mediaGeralNivel = 3;
                            cor = "green";
                        } else if (resposta[i].media_geral_rota <= 72) {
                            mediaGeralNivel = 2;
                            cor = "green";
                        } else if (resposta[i].media_geral_rota <= 90) {
                            mediaGeralNivel = 1;
                            cor = "green";
                        }
                        console.log("PUSH: " + resposta[i].idRota)
                        rotasList.push(resposta[i].idRota);
                        rotas.innerHTML += `
                            <div class="rota">
                                <div style="color: ${cor}" class="tituloENivel">
                                    <h1 style="margin:0">${resposta[i].nomeRota}</h1>
                                    <h1>${mediaGeralNivel}</h1>
                                </div>
                                <div class="lixeiras">
                                    <ul id="lixeira${resposta[i].idRota}">
                                        
                                    </ul>
                                </div>
                            </div>
                        `
                    }
                    mediaCincoPontos(idUsuario);
                })
            }
        })
    }

    function mediaCincoPontos(idUsuario) {
        console.log("ROTAS LIST LENGHT: " + rotasList.length)
        fetch("/dashboard/mediaCincoPontos", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idUsuarioServer: idUsuario,
                rotasListServer: rotasList
            }),
        }).then(function (resposta) {
            console.log("ENTROU NO THEN")
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    let ListaID = [];
                    let encontar = false;
                    for (var i = 0; i < resposta.length; i++) {
                        var cor = null;
                        if (resposta[i].media_nivel_lixo <= 18) {
                            cor = "red";
                            ListaID.push(resposta[i].idPontoColeta);
                            encontar = true;
                        } else if (resposta[i].media_nivel_lixo <= 36) {
                            cor = "yellow";
                            ListaID.push(resposta[i].idPontoColeta);
                            encontar = true;
                        } else if (resposta[i].media_nivel_lixo <= 54) {
                            cor = "green";
                        } else if (resposta[i].media_nivel_lixo <= 72) {
                            cor = "green";
                        } else if (resposta[i].media_nivel_lixo <= 90) {
                            cor = "green";
                        }
                        var lixeira = document.getElementById("lixeira" + resposta[i].idRota);
                        lixeira.innerHTML += `
                            <li style="background-color: ${cor}; border-radius:10%;"><img src="./imgs/trash-512.webp" alt=""></li>
                        `
                    }
                    if (encontar == true) {
                        div_alerta.innerHTML = `
                            <div class="alerta-lixo">
                            <div class="alerta-lixo" id="alertaLixo">
                            <button class="fechar-alerta" onclick="fecharAlerta()">×</button>
                            <span>Alerta:</span> Pontos de Coletas com <span>Urgência</span>:<br>
                            <span>${ListaID}</span>
                            </div>
                        `
                    }
                })
            }
        })
    }

    function fecharAlerta() {
        document.getElementById('alertaLixo').style.display = 'none';
    }

</script>

</html>